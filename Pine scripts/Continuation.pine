//@version=5
indicator("EMA Continuation Signals", overlay=true)

// === INPUTS ===
emaLength = input.int(20, "EMA Length", minval=1)
macdFast = input.int(12, "MACD Fast Length", minval=1)
macdSlow = input.int(26, "MACD Slow Length", minval=1)
macdSignal = input.int(9, "MACD Signal Length", minval=1)

barsAboveEMA = input.int(3, "Bars Above/Below EMA Required", minval=1, tooltip="Number of bars price must be above/below EMA before signal")
emaTolerance = input.float(0.5, "EMA Distance Tolerance", minval=0, tooltip="Maximum distance in price units from EMA to still count as a bounce")
minBodyDistance = input.float(1.0, "Minimum Body Distance from EMA", minval=0, tooltip="Minimum distance the candle body must be from EMA (prevents body sitting on EMA)")

// === CALCULATIONS ===
// EMA
ema20 = ta.ema(close, emaLength)

// MACD
[macdLine, signalLine, histLine] = ta.macd(close, macdFast, macdSlow, macdSignal)
macdPositive = histLine > 0
macdNegative = histLine < 0

// Candle components
bodyTop = math.max(close, open)
bodyBottom = math.min(close, open)

// Check if price has been above/below EMA
var int barsAboveCount = 0
var int barsBelowCount = 0

if close > ema20
    barsAboveCount := barsAboveCount + 1
    barsBelowCount := 0
else if close < ema20
    barsBelowCount := barsBelowCount + 1
    barsAboveCount := 0
else
    barsAboveCount := 0
    barsBelowCount := 0

// === BULLISH SIGNAL CONDITIONS ===
// 1. Price has been above EMA for required number of bars (continuation, not breakout)
priceAboveEMA = barsAboveCount >= barsAboveEMA

// 2. Wick rejection: Lower wick touches/pierces EMA OR comes within tolerance
// Distance from wick to EMA
distanceToEMA = low - ema20
wickNearEMA = distanceToEMA <= emaTolerance and distanceToEMA >= -emaTolerance
wickTouchesEMA = wickNearEMA and low < open and low < close

// 3. Body is sufficiently above EMA (clear rejection, not sitting on EMA)
bodyDistanceFromEMA = bodyBottom - ema20
bodyAboveEMA = bodyDistanceFromEMA >= minBodyDistance

// 4. MACD is positive
bullishMacd = macdPositive

// Combined bullish signal
bullishSignal = priceAboveEMA and wickTouchesEMA and bodyAboveEMA and bullishMacd

// === BEARISH SIGNAL CONDITIONS ===
// 1. Price has been below EMA for required number of bars (continuation, not breakout)
priceBelowEMA = barsBelowCount >= barsAboveEMA

// 2. Wick rejection: Upper wick touches/pierces EMA OR comes within tolerance
// Distance from wick to EMA
distanceToEMABear = high - ema20
wickNearEMABear = distanceToEMABear >= -emaTolerance and distanceToEMABear <= emaTolerance
wickTouchesEMABear = wickNearEMABear and high > open and high > close

// 3. Body is sufficiently below EMA (clear rejection, not sitting on EMA)
bodyDistanceFromEMABear = ema20 - bodyTop
bodyBelowEMA = bodyDistanceFromEMABear >= minBodyDistance

// 4. MACD is negative
bearishMacd = macdNegative

// Combined bearish signal
bearishSignal = priceBelowEMA and wickTouchesEMABear and bodyBelowEMA and bearishMacd

// === PLOTTING ===
// Plot EMA
plot(ema20, "EMA 20", color=color.rgb(255, 82, 82), linewidth=2)

// Plot signals
plotshape(bullishSignal, "Bullish Continuation", shape.triangleup, location.belowbar, color.new(color.green, 0), size=size.small)
plotshape(bearishSignal, "Bearish Continuation", shape.triangledown, location.abovebar, color.new(color.red, 0), size=size.small)

// Background color for trend
bgcolor(barsAboveCount >= barsAboveEMA ? color.new(color.green, 95) : barsAboveCount >= 1 ? color.new(color.green, 98) : na)
bgcolor(barsBelowCount >= barsAboveEMA ? color.new(color.red, 95) : barsBelowCount >= 1 ? color.new(color.red, 98) : na)

// === ALERTS ===
alertcondition(bullishSignal, title="Bullish Continuation", message="Bullish EMA Continuation Signal: Wick rejection off 20 EMA with positive MACD")
alertcondition(bearishSignal, title="Bearish Continuation", message="Bearish EMA Continuation Signal: Wick rejection off 20 EMA with negative MACD")
alertcondition(bullishSignal or bearishSignal, title="Any Continuation Signal", message="EMA Continuation Signal Detected")
